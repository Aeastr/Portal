name: Dev Snapshot

# Creates development snapshot pre-releases when PRs are merged to the dev branch
# Snapshots are for testing changes before manually creating a release
# Format: dev-YYYYMMDD-HHMMSS-sha (e.g., dev-20250113-143022-a1b2c3d)
on:
  pull_request:
    types: [closed]
    branches: [ dev ]

# Prevent concurrent snapshots for the same PR
concurrency:
  group: snapshot-${{ github.event.pull_request.merge_commit_sha }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

env:
  DRAFT_RELEASE: 'false'

jobs:
  snapshot:
    name: Create Dev Snapshot
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.pull_request.merged == true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.merge_commit_sha }}
        fetch-depth: 0

    - name: Fetch all tags
      shell: bash
      run: |
        git fetch --tags

    - name: Generate snapshot tag
      id: snapshot
      shell: bash
      run: |
        # Generate timestamp-based snapshot tag
        TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
        SHORT_SHA=$(git rev-parse --short=7 HEAD)
        SNAPSHOT_TAG="dev-${TIMESTAMP}-${SHORT_SHA}"

        echo "Snapshot tag: $SNAPSHOT_TAG"
        echo "tag=$SNAPSHOT_TAG" >> $GITHUB_OUTPUT
        echo "release_name=Dev Snapshot $SNAPSHOT_TAG" >> $GITHUB_OUTPUT

    - name: Generate changelog from commits
      id: changelog
      shell: bash
      run: |
        PR_NUMBER="${{ github.event.pull_request.number }}"
        PR_TITLE="${{ github.event.pull_request.title }}"

        # Get the previous dev snapshot or release tag
        PREV_TAG=$(git tag -l --sort=-v:refname | head -1)

        if [ -n "$PREV_TAG" ]; then
          echo "Generating changelog from $PREV_TAG to HEAD"
          CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)

          if [ -n "$CHANGELOG" ]; then
            echo "## Changes in this snapshot" > changelog.txt
            echo "" >> changelog.txt
            echo "$CHANGELOG" >> changelog.txt
          else
            echo "## Changes in this snapshot" > changelog.txt
            echo "" >> changelog.txt
            echo "- $PR_TITLE (PR #${PR_NUMBER})" >> changelog.txt
          fi
        else
          echo "## Initial Snapshot" > changelog.txt
          echo "" >> changelog.txt
          echo "First development snapshot" >> changelog.txt
        fi

        cat changelog.txt

    - name: Prepare release notes
      id: notes
      shell: bash
      run: |
        # Start with snapshot warning
        echo "‚ö†Ô∏è **Development snapshot - for testing only**" > release_notes.txt
        echo "" >> release_notes.txt
        echo "This is an automated snapshot of the \`dev\` branch." >> release_notes.txt
        echo "" >> release_notes.txt
        echo "---" >> release_notes.txt
        echo "" >> release_notes.txt
        cat changelog.txt >> release_notes.txt

        # Save to output
        DELIMITER="EOF_$(date +%s)_$$"
        echo "notes<<$DELIMITER" >> $GITHUB_OUTPUT
        cat release_notes.txt >> $GITHUB_OUTPUT
        echo "$DELIMITER" >> $GITHUB_OUTPUT

    - name: Check if tag exists on remote
      shell: bash
      run: |
        TAG="${{ steps.snapshot.outputs.tag }}"

        # Check if exact tag exists remotely (should be unique due to timestamp)
        if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
          echo "::error::Tag $TAG already exists on remote"
          exit 1
        fi

        echo "Tag $TAG is available"

    - name: Create and push tag
      id: create_tag
      shell: bash
      run: |
        TAG="${{ steps.snapshot.outputs.tag }}"

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Create annotated tag
        git tag -a "$TAG" -m "Dev snapshot $TAG"

        # Push tag with retry logic
        MAX_RETRIES=3
        RETRY_COUNT=0

        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if git push origin "$TAG"; then
            echo "Successfully pushed tag $TAG"
            echo "success=true" >> $GITHUB_OUTPUT
            exit 0
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Failed to push tag (attempt $RETRY_COUNT/$MAX_RETRIES)"
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 2
            fi
          fi
        done

        echo "::error::Failed to push tag after $MAX_RETRIES attempts"
        echo "success=false" >> $GITHUB_OUTPUT
        git tag -d "$TAG"
        exit 1

    - name: Create GitHub Snapshot Release
      id: create_release
      if: steps.create_tag.outputs.success == 'true'
      shell: bash
      run: |
        TAG="${{ steps.snapshot.outputs.tag }}"
        RELEASE_NAME="${{ steps.snapshot.outputs.release_name }}"

        # Create snapshot pre-release using GitHub CLI
        gh release create "$TAG" \
          --title "$RELEASE_NAME" \
          --notes "${{ steps.notes.outputs.notes }}" \
          --prerelease \
          --verify-tag

        echo "success=true" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify on success
      if: steps.create_release.outputs.success == 'true'
      continue-on-error: true
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="${{ steps.snapshot.outputs.tag }}"
        RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$TAG"

        gh pr comment "${{ github.event.pull_request.number }}" \
          --body "üì∏ **Dev snapshot $TAG created**

        This snapshot is available for testing via Swift Package Manager:

        \`\`\`swift
        .package(url: \"https://github.com/${{ github.repository }}\", exact: \"$TAG\")
        \`\`\`

        [View snapshot release]($RELEASE_URL)" || echo "::warning::Unable to comment on PR (may be closed)"

    - name: Cleanup on failure
      if: failure() && steps.create_tag.outputs.success == 'true'
      shell: bash
      run: |
        TAG="${{ steps.snapshot.outputs.tag }}"
        echo "::warning::Snapshot creation failed. Cleaning up tag $TAG"

        git push --delete origin "$TAG" || echo "Failed to delete remote tag"
        echo "::error::Snapshot creation failed. Tag has been cleaned up."

    - name: Notify on failure
      if: failure()
      continue-on-error: true
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="${{ steps.snapshot.outputs.tag }}"
        RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        echo "::error::Snapshot workflow failed for $TAG"
        echo "::error::Workflow run: $RUN_URL"

        gh pr comment "${{ github.event.pull_request.number }}" \
          --body "‚ö†Ô∏è **Dev snapshot creation failed**

        The automated snapshot process encountered an error. Please check the [workflow logs]($RUN_URL) for details." || echo "::warning::Unable to comment on PR (may be closed)"
