name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Tests
    runs-on: macos-15

    strategy:
      matrix:
        scheme: ['Portal', 'PortalFlowingHeader', 'PortalPrivate', 'PortalView']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Build and test ${{ matrix.scheme }}
      run: |
        set -o pipefail
        xcodebuild test \
          -scheme ${{ matrix.scheme }} \
          -destination 'platform=iOS Simulator,OS=latest' \
          -enableCodeCoverage YES \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.scheme }}
        path: TestResults-${{ matrix.scheme }}.xcresult
        retention-days: 30
